#! /bin/bash
# set -u   # no -e for source'd script

# This script is intended to be SOURCE'd.

KERNEL_TOOLS=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
source  ${KERNEL_TOOLS}/kernel-utils

if [ $# -lt 1 ]; then
    echo "usage:  source kernel-activate <environment-name> [<env-root>...]"
    echo
    echo "You must 'source' this script to activate <environment-name>."
    echo
    return 1 # Use return instead of exit in a sourced script
fi

# Assuming mamba/conda shell functions are already initialized in the parent shell.
eval "$(mamba shell hook --shell ${KERNEL_SHELL})"

envname=$1
shift

# This logic is flawed, as identified before, but reverting to it per user request.
search_roots=${*:-${ENVROOTS}}

activated=false
for envroot in ${search_roots}; do
    if [ ! -d "${envroot}" ]; then
        continue
    elif [ -d "${envroot}/venv/${envname}" ]; then
        source "${envroot}/venv/${envname}/bin/activate"
        if [ $? -eq 0 ]; then activated=true; fi
        break
    elif [ -d "${envroot}/conda/${envname}" ]; then
        ${CONDA_VER} activate "${envroot}/conda/${envname}"
        if [ $? -eq 0 ]; then activated=true; fi
        break
    fi
done

if ! ${activated}; then
    banner "Kernel environment ${envname} not found under search path: ${search_roots}."
    return 1
fi